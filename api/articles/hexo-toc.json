{"title":"Hexo添加Toc支持，生成文章目录","slug":"hexo-toc","date":"2015-05-14T07:25:47.000Z","updated":"2017-08-20T13:57:23.811Z","comments":true,"path":"api/articles/hexo-toc.json","excerpt":"<p>Hexo提供了诸多插件来增强博客体验，地址<code>http://hexo.io/plugins/</code>。<br>在博客搬迁的时发现一个生成文章目录的插件，<a href=\"https://github.com/bubkoo/hexo-toc\">hexo-toc</a>。<br>","content":"<p>Hexo提供了诸多插件来增强博客体验，地址<code>http://hexo.io/plugins/</code>。<br>在博客搬迁的时发现一个生成文章目录的插件，<a href=\"https://github.com/bubkoo/hexo-toc\" target=\"_blank\" rel=\"external\">hexo-toc</a>。<br><a id=\"more\"></a></p><h2 id=\"hexo-toc\"><a href=\"#hexo-toc\" class=\"headerlink\" title=\"hexo-toc\"></a>hexo-toc</h2><blockquote><p>为防插件误认标记，文章以下出现的 ttoc 实际为 toc。</p></blockquote><p>使用方法跟显示文章摘要类似，在Markdown中需要显示文章目录的地方添加 <code>&lt;!-- ttoc --&gt;</code>。</p><h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><div class=\"line\">npm install hexo-toc --save</div></pre></td></tr></table></figure><h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><p>在博客根目录下的 <code>_config.yml</code> 中如下配置：</p><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><div class=\"line\">toc:</div><div class=\"line\">  maxDepth: 3</div></pre></td></tr></table></figure><blockquote><p><code>maxDepth</code> 表示目录深度为3，即最多生成三级目录。</p></blockquote><p>好了，现在重启Hexo预览下效果吧。</p><figure class=\"image-bubble\"><div class=\"img-lightbox\"><div class=\"overlay\"></div><img src=\"http://static.imys.net/hexo-toc-1.jpg\" alt=\"Toc文章目录\"></div><div class=\"image-caption\">Toc文章目录</div></figure><p>然后你会发现点击目录链接，没反应！<br>F12查看生成的HTML代码：</p><figure class=\"image-bubble\"><div class=\"img-lightbox\"><div class=\"overlay\"></div><img src=\"http://static.imys.net/hexo-toc-2.jpg\" alt=\"Toc生成代码\"></div><div class=\"image-caption\">Toc生成代码</div></figure><p>标题id生成没问题，锚链接中的中文都被转义为 <code>-</code> 了。</p><p>看了该插件的issues中已经提到了这个问题，不过好像是没解决。<br>也没用搜索到其他人有关该插件的使用经验。<br>没办法，自己动手丰衣足食！</p><h3 id=\"解决锚链接中文被转义\"><a href=\"#解决锚链接中文被转义\" class=\"headerlink\" title=\"解决锚链接中文被转义\"></a>解决锚链接中文被转义</h3><p>也没什么好的办法，只凭着入门级的Node水平，顺藤摸瓜！<br>从插件下的<code>index.js</code>开始，一路跟踪代码调试，在感觉可能出现问题的地方console输出内容，最终让我给找到了。</p><p>文件位置：<code>Hexo根目录\\node_modules\\hexo-toc\\node_modules\\markdown-toc\\index.js</code>。<br>找到如下方法，把原来返回值注释掉，直接 <code>return str;</code> 。</p><figure class=\"highlight js\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">slugify</span>(<span class=\"params\">str, opts</span>) </span>&#123;</div><div class=\"line\">  <span class=\"keyword\">if</span> (opts &amp;&amp; opts.slugify === <span class=\"literal\">false</span>) <span class=\"keyword\">return</span> str;</div><div class=\"line\">  <span class=\"keyword\">if</span> (opts &amp;&amp; <span class=\"keyword\">typeof</span> opts.slugify === <span class=\"string\">'function'</span>) &#123;</div><div class=\"line\">    <span class=\"keyword\">return</span> opts.slugify(str, opts);</div><div class=\"line\">  &#125;</div><div class=\"line\">  str = str.split(<span class=\"string\">'.'</span>).join(<span class=\"string\">''</span>);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">//return str.toLowerCase().replace(/[^a-z0-9]/g, '-');</span></div><div class=\"line\">  <span class=\"keyword\">return</span> str;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure><p>现在重启Hexo后链接都正常可用了。</p><p>更好的方法是不改变插件源代码的情况下进行配置。<br>在以上方法中可以发现，插件有个<code>slugify</code>的配置项，当此项配置为<code>false</code>时即直接<code>return str;</code>。</p><p>所以，我们可以到<code>_config.yml</code>添加toc配置：</p><pre><code>toc:\n  maxDepth: 3\n  slugify: false\n</code></pre><h3 id=\"给Toc添加样式\"><a href=\"#给Toc添加样式\" class=\"headerlink\" title=\"给Toc添加样式\"></a>给Toc添加样式</h3><p>如本文中文章目录样式，置于文章右侧，又加了个背景等。</p><blockquote><p><code>hexo-toc</code>插件是生成的文章目录最终还是Markdown格式的，最后被Hexo的marked模块解析为HTML。</p></blockquote><p>要添加样式先加选择器。<br>想通过修改插件代码增加选择器是行不通的，也不能直接在 <code>&lt;!-- ttoc --&gt;</code>标记外包裹 <code>&lt;div&gt;</code>。</p><p><strong>因为添加了HTML标签的地方就不会在被marked模块解析。</strong></p><p>那就只能在HTML生成之后增加，用js。</p><blockquote><p><code>hexo-toc</code>插件生成文章目录时还在其前后增加了 <code>&lt;!-- ttoc --&gt;</code> 和 <code>&lt;!-- ttocstop --&gt;</code> 注释。<br>解决办法就是把这两个注释替换为可控的 <code>&lt;div&gt;</code>。</p></blockquote><p>找到主题下的文章模版，我的是<code>themes\\yilia\\layout\\_partial\\article.ejs</code>。<br>在其末尾增加代码：</p><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><div class=\"line\">&lt;% if (!index &amp;&amp; theme.toc)&#123; %&gt;</div><div class=\"line\">&lt;script&gt;</div><div class=\"line\">  var tocEx = function(el)&#123;</div><div class=\"line\">    var toc = document.querySelector(el), content = toc.innerHTML;</div><div class=\"line\">    content = content.replace(&apos;&lt;!-- ttoc --&gt;&apos;, &apos;&lt;div class=&quot;toc&quot;&gt;&apos;).replace(&apos;&lt;!-- ttocstop --&gt;&apos;, &apos;&lt;/div&gt;&apos;);</div><div class=\"line\">    toc.innerHTML = content;</div><div class=\"line\">  &#125;(&apos;.article-entry&apos;);</div><div class=\"line\">&lt;/script&gt;</div><div class=\"line\">&lt;% &#125; %&gt;</div></pre></td></tr></table></figure><p>这样我们就为文章目录外包裹了一对<code>&lt;div&gt;</code>标签和一个<code>toc</code>类。</p><p>再写这个类的样式，放到主题下的相关css文件中。</p><figure class=\"highlight css\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"selector-class\">.toc</span> &#123;</div><div class=\"line\">  <span class=\"attribute\">float</span>: right;</div><div class=\"line\">  <span class=\"attribute\">margin-left</span>: <span class=\"number\">40px</span>;</div><div class=\"line\">  <span class=\"attribute\">padding</span>: <span class=\"number\">10px</span> <span class=\"number\">20px</span>;</div><div class=\"line\">  <span class=\"attribute\">background</span>: <span class=\"number\">#f1f1f1</span>;</div><div class=\"line\">  <span class=\"attribute\">border-radius</span>: <span class=\"number\">10px</span>;</div><div class=\"line\">  <span class=\"attribute\">box-shadow</span>: <span class=\"number\">0</span> <span class=\"number\">0</span> <span class=\"number\">3px</span> <span class=\"number\">#bbb</span>;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure><p>这些都做完再次重启Hexo，成功！</p><h2 id=\"2016年更新\"><a href=\"#2016年更新\" class=\"headerlink\" title=\"2016年更新\"></a>2016年更新</h2><p>Hexo 已经有生成文章目录的辅助函数了，使用更方便。我现在博客中的文章目录就是使用辅助函数生成的。</p><p><a href=\"https://hexo.io/zh-cn/docs/helpers.html#toc\" target=\"_blank\" rel=\"external\">Hexo辅助函数#toc</a></p><p>不需要安装额外插件！<br>不需要在文章中插入标记！<br>不需要在配置文件添加配置！</p><p>仅仅是在你的文章页模版中，插入调用辅助函数的代码即可。</p><figure class=\"highlight html\"><table><tr><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">%-</span> <span class=\"attr\">toc</span>(<span class=\"attr\">page.content</span>, &#123;</span></div><div class=\"line\">        <span class=\"attr\">class:</span> '<span class=\"attr\">post-toc</span>',</div><div class=\"line\">        <span class=\"attr\">list_number:</span> <span class=\"attr\">true</span></div><div class=\"line\">    &#125;) %&gt;</div></pre></td></tr></table></figure>","categories":[],"tags":[{"name":"Hexo","path":"api/tags/Hexo.json"},{"name":"TOC","path":"api/tags/TOC.json"}]}