<!DOCTYPE html><html><head><!-- Google Analytics --><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-87940530-1","auto"),ga("send","pageview");</script><script async src="https://www.google-analytics.com/analytics.js"></script><!-- End Google Analytics --><meta charset="utf-8"><meta name="google-site-verification" content="rlxpN--EBnMOLJnY1efTuwShQId3YX7A6RWkQEr0y9c"><link rel="canonical" href="https://imys.net/20150908/gulp-ejs-module.html"><title>使用gulp+ejs模块化html | Yusen&#39;s Blog | 学习弯道超车的技巧！</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#3F51B5"><meta name="keywords" content="Gulp,Ejs,模块化"><meta name="description" content="使用gulp+ejs模块化html"><meta property="og:type" content="article"><meta property="og:title" content="使用gulp+ejs模块化html"><meta property="og:url" content="http://imys.net/20150908/gulp-ejs-module.html"><meta property="og:site_name" content="Yusen's Blog"><meta property="og:description" content="使用gulp+ejs模块化html"><meta property="og:updated_time" content="2016-11-12T19:13:01.627Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="使用gulp+ejs模块化html"><meta name="twitter:description" content="使用gulp+ejs模块化html"><link rel="alternate" type="application/atom+xml" title="Yusen&#39;s Blog" href="/atom.xml"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css?v=1.7.2"><script>window.lazyScripts=[];</script><!-- custom head --></head><body><div id="loading" class="active"></div><aside id="menu" class="hide"><div class="inner flex-row-vertical"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off"><i class="icon icon-lg icon-close"></i></a><div class="brand-wrap" style="background-image:url(/img/brand.jpg)"><div class="brand"><a href="/" class="avatar waves-effect waves-circle waves-light"><img src="/img/face.jpg"></a><hgroup class="introduce"><h5 class="nickname">王昱森</h5><a href="mailto:634206017@qq.com" title="634206017@qq.com" class="mail">634206017@qq.com</a></hgroup></div></div><div class="scroll-wrap flex-col"><ul class="nav"><li class="waves-block waves-effect"><a href="/"><i class="icon icon-lg icon-home"></i> Home</a></li><li class="waves-block waves-effect"><a href="/archives"><i class="icon icon-lg icon-archives"></i> Archives</a></li><li class="waves-block waves-effect"><a href="/tags"><i class="icon icon-lg icon-tags"></i> Tags</a></li><li class="waves-block waves-effect"><a href="https://github.com/yscoder" target="_blank"><i class="icon icon-lg icon-github"></i> Github</a></li><li class="waves-block waves-effect"><a href="http://www.weibo.com/ysweb" target="_blank"><i class="icon icon-lg icon-weibo"></i> Weibo</a></li></ul></div></div></aside><main id="main"><header class="top-header" id="header"><div class="flex-row"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle"><i class="icon icon-lg icon-navicon"></i></a><div class="flex-col header-title ellipsis">使用gulp+ejs模块化html</div><div class="search-wrap" id="search-wrap"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back"><i class="icon icon-lg icon-chevron-left"></i></a> <input id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字"> <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search"><i class="icon icon-lg icon-search"></i></a></div><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare"><i class="icon icon-lg icon-share-alt"></i></a></div></header><header class="content-header post-header"><div class="container fade-scale"><h1 class="title">使用gulp+ejs模块化html</h1><h5 class="subtitle"><time datetime="2015-09-08T10:04:47.000Z" itemprop="datePublished" class="page-time">2015年09月8日</time></h5></div></header><div class="container body-wrap"><aside class="post-widget"><nav class="post-toc-wrap post-toc-shrink" id="post-toc"><h4>TOC</h4><ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#目录结构"><span class="post-toc-number">1.</span> <span class="post-toc-text">目录结构</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#工作流程"><span class="post-toc-number">2.</span> <span class="post-toc-text">工作流程</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#未模块化页面的处理"><span class="post-toc-number">3.</span> <span class="post-toc-text">未模块化页面的处理</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#完整Demo"><span class="post-toc-number">4.</span> <span class="post-toc-text">完整Demo</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#写在最后"><span class="post-toc-number">5.</span> <span class="post-toc-text">写在最后</span></a></li></ol></nav></aside><article id="post-gulp-ejs-module" class="post-article article-type-post fade" itemprop="blogPost"><div class="post-card"><h1 class="post-card-title">使用gulp+ejs模块化html</h1><div class="post-meta"><time class="post-time" title="2015年09月8日 18:04:47" datetime="2015-09-08T10:04:47.000Z" itemprop="datePublished">2015年09月8日</time></div><div class="post-content" id="post-content" itemprop="postContent"><p>在静态页面目录中，同子目录下的页面往往有很多通用的模块。<br>平常的编码一般是通用的代码直接复制到各个页面，样式写成公用，然后在各个需要的页面引用。<br>而一个产品在实地运行中往往要经历无数次的迭代，于是页面文档结构和样式也在不断的变化。<br>独立性的页面比较轻松，一个页面修改就好了，而一些公用的页面模块往往需要在各个页面逐个修改。<br>这显然是一种极其枯燥的重复性动作！</p><p>在此之前我用 <code>C#</code> 写了一个文件批量替换的工具，用于批量替换某个目录下的某个模块代码。<br>虽然效率提高了一些，但是从方法学角度看绝对不是最好的。</p><p>很久之前就想过使用前端模块拼装 html。<br>以 <code>ejs</code> 为例，则需要在页面中引入模版解析文件 <code>ejs.js</code>，页面中还需要写一些 ejs 相关的配置代码。而这些东西对于后端套用页面来说是无用的，可能还会造成一些混乱。<br>还有一种引用方式是使用 <code>nodeJs</code> 调用 ejs 去解析模版文件，这样在预览静态页面时则需要建立 node 服务器。而当前团队中并不是每个人都装有 node 环境。</p><p>最近工作闲暇了又想到这个问题，其实要解决的最根本问题就是：</p><blockquote><p>模块化开发页面，开发完成后可以一条指令合并成可直接预览的静态页面。</p></blockquote><p>我早该想到 <code>gulp</code> 了，既然 gulp 是一个基于流的前端构建工具，那么对于这个问题应该是可以解决的。</p><a id="more"></a><p><strong>起初我是这样想的：</strong></p><ol><li>模板中使用相对路径标记模块引用</li><li>读取文件把这些标记还原为路径</li><li>读取这些路径的文件内容插入到模板中</li><li>生成到对应目标目录</li></ol><p>这样做等于实现了一套模版解析合并的过程，并不困难。</p><p>在探索的过程中，我发现了一个基于 gulp 和 ejs 的插件 <code>gulp-ejs</code>，并按照示例实验后达成了我的想法。<br>随后新的问题便来了。</p><p>每个页面有着不同标题和样式、脚本引用，虽然可以在执行 gulp 任务时指定参数，但是不可能每个页面的参数配置都一样。<br>难道要为每个页面编写一个任务？你会甘心用这么傻的办法吗？<br>从设计模式角度讲，这个任务应该是唯一的，但是可以根据一些参数配置达到多态！</p><p><strong>之后我改造了 <code>gulp-ejs</code>：</strong></p><ol><li>在模板文件同级目录下添加同名的 <code>.json</code> 配置文件</li><li>在其对模板渲染时获取模板路径，再转换后缀为 json，这样就匹配到了对应的配置文件</li><li>解析 json 文件为 json 对象，作为参数传入 ejs 中，这样模版内就可以访问配置文件的数据了</li><li>之后便可以根据配置文件随心所欲的插入当前页面的特定项目</li></ol><p>这样标题、样式、脚本，神马都解决了！</p><p>就在刚才我又想到了另外一个主意。</p><p>如果你觉得每个模板对应一个 json 文件麻烦的话，可以只建立一个配置文件。<br>假如你有 index 、product 、service 三个模版，那么你的配置文件可以这样写：</p><figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"index"</span>: &#123;</div><div class="line">        <span class="attr">"title"</span>: <span class="string">"首页"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"product"</span>: &#123;</div><div class="line">        <span class="attr">"title"</span>: <span class="string">"产品页"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"service"</span>: &#123;</div><div class="line">        <span class="attr">"title"</span>: <span class="string">"服务页"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>那么在 index 模版中输出 <code>title</code>，就可以写成 <code>&lt;%=index.title %&gt;</code> 这种格式。<br>长久下去配置文件一定会越来越大，而且每个模版中都被注入了整站的配置项，真的好吗？</p><ul><li>为了使每个页面只注入当前页面的数据，可以在模版渲染前拿到模版名称，如 index ；</li><li>向 ejs 传入的数据就变成了 <code>config[&quot;index&quot;]</code>；</li><li>这样在每个模版中依然可以直接用 <code>&lt;%=title %&gt;</code> 这种格式调用了</li></ul><p>不管采取哪种办法，最终的结果是一致的。哪怕是每个模版注入整站配置的做法，也只是在 gulp 任务阶段执行效率低点，并不会上升到影响性能的高度。<br>不过，我还是倾向于一个页面对应一个配置文件的办法，谁让我是处女座。</p><p>以下是对该方案的简单描述。</p><h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><pre><code>├ templates     模版
├──── _partial      模块
├──────── header.ejs   
├──────── footer.ejs
├──────── nav.ejs
├──────── left.ejs
├──────── right.ejs
├──── index.ejs    布局页
├──── index.json    布局页配置文件
├ html      页面
├──── index.html    生成的静态页面
├ node_modules  node模块
├ gulpfile.js   gulp
</code></pre><h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><ol><li>模板编码，即 <code>templates/</code> 目录，一个布局页对应一个同名静态页面，按需引入或编写新的页面模块。在这个阶段可以使用express建立node服务器进行实时页面预览。</li><li>编写配置文件，使用通用的 <code>json</code> 格式，一个页面对应一个同名的配置文件。目前预想的配置信息有： <code>title：页面标题</code> 、<code>styles：依赖的样式文件路径</code>、 <code>scripts：依赖的脚本文件路径</code> ，随时可以根据实际情况添加新的配置。</li><li>执行 <code>gulp</code> 任务，生成页面到 <code>html/</code> 目录。</li></ol><h2 id="未模块化页面的处理"><a href="#未模块化页面的处理" class="headerlink" title="未模块化页面的处理"></a>未模块化页面的处理</h2><p>之前未模块化的静态页面，保持原样即可，因为在这个流程中与之前的页面是没有任何冲突关系的。<br>一些频繁修改的页面，可以按需抽取出模块，进行页面分割。</p><h2 id="完整Demo"><a href="#完整Demo" class="headerlink" title="完整Demo"></a>完整Demo</h2><blockquote><p><a href="https://github.com/yscoder/gulp-ejs-demo" target="_blank" rel="external">https://github.com/yscoder/gulp-ejs-demo</a></p></blockquote><h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>可能我所做的这些对于国内一些优秀的前端团队来说很土，但是适合的才是最好的！<br>目前我所在的公司前端的职能还仅限于页面编码、交互实现和一些通用插件开发，起点真的很低。<br>不过，这也让我有了更多的机会去改革和实践新技术。</p></div><blockquote class="post-copyright"><div class="content"><span class="post-time">最后更新时间：<time datetime="2016-11-12T19:13:01.627Z" itemprop="dateUpdated">2016年11月13日 3:13:01</time></span><br>原始链接：<a href="/20150908/gulp-ejs-module.html" target="_blank" rel="external">http://imys.net/20150908/gulp-ejs-module.html</a></div><footer><a href="http://imys.net"><img src="/img/face.jpg" alt="王昱森"> 王昱森</a></footer></blockquote><div class="page-reward"><a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a></div><div class="post-footer"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ejs/">Ejs</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Gulp/">Gulp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/模块化/">模块化</a></li></ul><div class="page-share-wrap"><div class="page-share" id="pageShare"><ul class="reset share-icons"><li><a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://imys.net/20150908/gulp-ejs-module.html&title=《使用gulp+ejs模块化html》 — Yusen's Blog&pic=http://imys.net/img/face.jpg" data-title="微博"><i class="icon icon-weibo"></i></a></li><li><a class="weixin share-sns wxFab" href="javascript:;" data-title="微信"><i class="icon icon-weixin"></i></a></li><li><a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://imys.net/20150908/gulp-ejs-module.html&title=《使用gulp+ejs模块化html》 — Yusen's Blog&source=在静态页面目录中，同子目录下的页面往往有很多通用的模块。平常的编码一般是通用的代码直接复制到各个页面，样式写成公用，然后在各个需要的页面引用。而一个产品在..." data-title=" QQ"><i class="icon icon-qq"></i></a></li><li><a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://imys.net/20150908/gulp-ejs-module.html" data-title=" Facebook"><i class="icon icon-facebook"></i></a></li><li><a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《使用gulp+ejs模块化html》 — Yusen's Blog&url=http://imys.net/20150908/gulp-ejs-module.html&via=http://imys.net" data-title=" Twitter"><i class="icon icon-twitter"></i></a></li><li><a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://imys.net/20150908/gulp-ejs-module.html" data-title=" Google+"><i class="icon icon-google-plus"></i></a></li></ul></div><a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle"><i class="icon icon-share-alt icon-lg"></i></a></div></div></div><nav class="post-nav flex-row flex-justify-between"><div class="waves-block waves-effect prev"><a href="/20150916/webapp-input-use-camera.html" id="post-prev" class="post-nav-link"><div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div><h4 class="title">Html5调用手机相机并压缩、上传</h4></a></div><div class="waves-block waves-effect next"><a href="/20150906/text-truncation.html" id="post-next" class="post-nav-link"><div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div><h4 class="title">前端文字的截断处理</h4></a></div></nav><!-- Valine Comments --><div class="comments vcomment" id="comments"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><!-- Valine Comments script --><script>var GUEST_INFO=["nick","mail","link"],guest_info="nick,mail".split(",").filter(function(e){return GUEST_INFO.indexOf(e)>-1});new Valine({el:"#comments",notify:!1,verify:!1,appId:"R0tGuv7HFlmrAVTKtuX8ceT7-gzGzoHsz",appKey:"KgvkCCIDO9CXUe5khfHdrtew",avatar:"retro",placeholder:"要不要说点什么？",guest_info:0==guest_info.length?GUEST_INFO:guest_info,pageSize:"20"});</script><!-- Valine Comments end --></article><div id="reward" class="page-modal reward-lay"><a class="close" href="javascript:;"><i class="icon icon-close"></i></a><h3 class="reward-title"><i class="icon icon-quote-left"></i> 请我吃辣条~ <i class="icon icon-quote-right"></i></h3><div class="reward-content"><div class="reward-code"><img id="rewardCode" src="/img/wechat.jpg" alt="打赏二维码"></div><label class="reward-toggle"><input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/wechat.jpg" data-alipay="/img/alipay.jpg"><div class="reward-toggle-ctrol"><span class="reward-toggle-item wechat">微信</span> <span class="reward-toggle-label"></span> <span class="reward-toggle-item alipay">支付宝</span></div></label></div></div></div><footer class="footer"><div class="top"><p><span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span> <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span></p></div><div class="bottom"><p><span>王昱森 &copy; 2015 - 2018</span> <span><a href="http://www.miitbeian.gov.cn/" target="_blank">豫ICP备17023738号-1</a><br>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></span></p></div></footer></main><div class="mask" id="mask"></div><a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a><div class="global-share" id="globalShare"><ul class="reset share-icons"><li><a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://imys.net/20150908/gulp-ejs-module.html&title=《使用gulp+ejs模块化html》 — Yusen's Blog&pic=http://imys.net/img/face.jpg" data-title="微博"><i class="icon icon-weibo"></i></a></li><li><a class="weixin share-sns wxFab" href="javascript:;" data-title="微信"><i class="icon icon-weixin"></i></a></li><li><a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://imys.net/20150908/gulp-ejs-module.html&title=《使用gulp+ejs模块化html》 — Yusen's Blog&source=在静态页面目录中，同子目录下的页面往往有很多通用的模块。平常的编码一般是通用的代码直接复制到各个页面，样式写成公用，然后在各个需要的页面引用。而一个产品在..." data-title=" QQ"><i class="icon icon-qq"></i></a></li><li><a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://imys.net/20150908/gulp-ejs-module.html" data-title=" Facebook"><i class="icon icon-facebook"></i></a></li><li><a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《使用gulp+ejs模块化html》 — Yusen's Blog&url=http://imys.net/20150908/gulp-ejs-module.html&via=http://imys.net" data-title=" Twitter"><i class="icon icon-twitter"></i></a></li><li><a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://imys.net/20150908/gulp-ejs-module.html" data-title=" Google+"><i class="icon icon-google-plus"></i></a></li></ul></div><div class="page-modal wx-share" id="wxShare"><a class="close" href="javascript:;"><i class="icon icon-close"></i></a><p>扫一扫，分享到微信</p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACMElEQVR42u3aS24bMRAFQN//0gqQVQDHo/ealhP1FFeC5RFZs2j0hx8f8Xr8Xn9+/vyXr/4/eerxaX28YmFgYLwt43G52qO365qRPIuBgXEfRhJkrwNo/mtJtKx/DQMDAyM49ONg5WEdAwMDIz/iddBsw+g/CLgYGBhvyEhC4Swct4H15bU4BgbGGzJmg4Gf+fzy+QYGBsZ/zzgpOPPt23ZefR4MDIzVjLZYPRlbno9Ln7wyDAyMpYx8m/aCV55oJt8+KZgxMDBWM9qNv5edN+mishYDA+NmjDZRy6+Ltelm8dIxMDCWMmYDwiQ1nA0p26sYGBgY92HkLftXTBLzEFznthgYGIsYs/FkHppnr6lo6mFgYNyAcbLlyVBz9hK/vDOCgYGxlHE+VmxfxKyhVoxLMTAwVjPax5K2Wts+G95rw8DAuAHju4aUs4pydpInUw4MDIxFjHZUOWvDtRfCWioGBsZuxvVP5IFvmIGW5W60FwYGxjpGG+ASTH39tGy3HY0wMTAw3pDRDgZmDbI8rJ+kpBgYGFsZs2DaBsH8WPlA4i+pIQYGxlJGHlhnLbnrcDwrfaMTYmBgLGLMLpjmh67z09ErwMDA2M04b9m3rbo26Txp22FgYGxi5EE2HwC0YfSktYeBgXEfRt7EnyWRdcusLbAxMDAwygRuFrJno1AMDAyMnHSS5LVFb3FbBAMDYxGjLWLbVHJWDBdUDAyM1Yx2MNAmc3XjbLQLBgbGUsYvWekUGTVsonYAAAAASUVORK5CYII=" alt="微信分享二维码"></div><script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script><script>var BLOG={ROOT:"/",SHARE:!0,REWARD:!0};</script><script src="/js/main.min.js?v=1.7.2"></script><div class="search-panel" id="search-panel"><ul class="search-result" id="search-result"></ul></div><template id="search-tpl"><li class="item"><a href="{path}" class="waves-block waves-effect"><div class="title ellipsis" title="{title}">{title}</div><div class="flex-row flex-middle"><div class="tags ellipsis">{tags}</div><time class="flex-col time">{date}</time></div></a></li></template><script src="/js/search.min.js?v=1.7.2" async></script></body></html>